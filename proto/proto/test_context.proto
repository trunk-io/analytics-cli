syntax = "proto3";

import "google/protobuf/timestamp.proto";

package test_context.test_run;

enum TestCaseRunStatus {
  TEST_CASE_RUN_STATUS_UNSPECIFIED = 0;
  TEST_CASE_RUN_STATUS_SUCCESS = 1;
  TEST_CASE_RUN_STATUS_FAILURE = 2;
  TEST_CASE_RUN_STATUS_SKIPPED = 3;
}

message CodeOwner {
  string name = 1;
}

message AttemptNumber {
  int32 number = 1;
}

message LineNumber {
  int32 number = 1;
}

message TestOutput {
  string text = 1;
  string message = 2;
  string system_out = 3;
  string system_err = 4;
}

message TestCaseRun {
  string id = 1;
  string name = 2;
  string classname = 3;
  string file = 4;
  string parent_name = 5;
  // Deprecated, use line_number instead
  int32 line = 6 [deprecated = true];
  TestCaseRunStatus status = 7;
  // Deprecated, use attempt_index instead
  int32 attempt_number = 8 [deprecated = true];
  google.protobuf.Timestamp started_at = 9;
  google.protobuf.Timestamp finished_at = 10;
  // Deprecated, use test_output instead
  string status_output_message = 11 [deprecated = true];
  bool is_quarantined = 12;
  repeated CodeOwner codeowners = 13;
  // Set by rspec, 0-indexed
  optional AttemptNumber attempt_index = 14;
  optional LineNumber line_number = 15;
  optional TestOutput test_output = 16;
}

message UploaderMetadata {
  string version = 1;
  string origin = 2; // RSpec, jest, etc..
  google.protobuf.Timestamp upload_time = 3;
  string variant = 4;
}

message BazelAttemptNumber {
  int32 number = 1;
}

message BazelBuildInformation {
  string label = 1; // test label for the execution 
  TestBuildResult result = 2; // result of the build
  optional BazelAttemptNumber max_attempt_number = 3; // attempt number of the target test
}

message TestResult {
  repeated TestCaseRun test_case_runs = 1;
  // use the uplaoder metadata in test report instead
  UploaderMetadata uploader_metadata = 2 [deprecated = true];;
  oneof test_build_information {
    BazelBuildInformation bazel_build_information = 3;
    // Other build information can be added here in the future
  }
}

enum TestBuildResult {
  TEST_BUILD_RESULT_UNSPECIFIED = 0;
  TEST_BUILD_RESULT_SUCCESS = 1;
  TEST_BUILD_RESULT_FAILURE = 2;
  TEST_BUILD_RESULT_SKIPPED = 3;
  TEST_BUILD_RESULT_FLAKY = 4;
}

message TestReport {
  repeated TestResult test_results = 1;
  UploaderMetadata uploader_metadata = 2;
}
